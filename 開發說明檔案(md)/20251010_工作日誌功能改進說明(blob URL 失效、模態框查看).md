# 工作日誌功能改進說明文檔

## 日期：2025-10-10

## 概述
本次更新主要針對工作日誌功能進行了三個方面的改進：
1. 解決了 blob URL 失效問題，改用後端永久 URL
2. 在工作日誌查看模態框中添加了圖片預覽和檔案下載功能
3. 修正了工作日誌管理中日期篩選器的時間格式問題

## 修改檔案清單
1. `src/components/PointsManagement/EmployeePanel/WorkLogEntry.js`
2. `src/components/worklog/WorkLogBrowse.js`

## 詳細修改說明

### 1. 解決 blob URL 失效問題

#### 問題描述
原本的設計使用 blob URL 來處理檔案預覽和下載，導致：
- Cookie 清除後無法訪問檔案
- 檔案 URL 是臨時的，不支持長期存儲
- 跨會話訪問困難

#### 解決方案
改用後端永久 URL 存儲和訪問檔案：
- 檔案實際存儲在後端 `uploads/WorkLog/` 目錄
- 檔案元數據存儲在 `FileAttachments` 表
- 使用後端 API 提供永久訪問路徑

#### 代碼修改 (WorkLogEntry.js)
```javascript
// 修改前
const handleFileUpload = async (event) => {
  const file = event.target.files[0];
  const blobUrl = URL.createObjectURL(file);
  uploadedFiles.push({
    id: Date.now(),
    url: blobUrl,
    // ...其他屬性
  });
};

// 修改後
const handleFileUpload = async (event) => {
  const file = event.target.files[0];
  const formData = new FormData();
  formData.append('file', file);
  formData.append('entityType', 'WorkLog');
  
  const response = await axios.post(
    `${pointsConfig.apiEndpoints.base}/fileupload/upload`,
    formData
  );
  
  uploadedFiles.push({
    id: response.data.id,
    url: `${pointsConfig.apiEndpoints.base}/fileupload/download/${response.data.id}`,
    // ...其他屬性
  });
};
```

### 2. 工作日誌查看模態框改進

#### 新增功能
- 添加圖片預覽功能
- 添加檔案下載功能
- 優化檔案信息顯示

#### 代碼修改 (WorkLogBrowse.js)
```javascript
// 新增的模態框內容
<Col span={24}>
  <p style={{ marginBottom: '12px' }}>
    <strong style={{ color: '#94a3b8' }}>附件：</strong>
  </p>
  <div style={{ display: 'flex', flexWrap: 'wrap', gap: '16px' }}>
    {attachments.map((attachment) => (
      <div key={attachment.id} style={{ width: '150px' }}>
        {attachment.type.startsWith('image/') ? (
          <Image
            src={attachment.url}
            alt={attachment.name}
            style={{ width: '100%', height: '100px', objectFit: 'cover' }}
          />
        ) : (
          <FileTextOutlined style={{ fontSize: '48px', color: '#60a5fa' }} />
        )}
        <div style={{ marginTop: '8px' }}>
          <div style={{ fontSize: '12px', color: '#64748b' }}>
            {attachment.name}
          </div>
          <Button
            type="link"
            onClick={() => {
              const link = document.createElement('a');
              link.href = attachment.url;
              link.download = attachment.name;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            }}
          >
            下載
          </Button>
        </div>
      </div>
    ))}
  </div>
</Col>
```

### 3. 日期篩選器時間格式修正

#### 問題描述
原本的日期篩選無法正確處理 UTC 時間，導致：
- 無法查詢到當天建立的工作日誌
- 時區轉換問題

#### 解決方案
使用 dayjs 的 UTC 插件處理時間轉換：
- 將日期轉換為 UTC 格式
- 確保時間範圍涵蓋整天

#### 代碼修改 (WorkLogBrowse.js)
```javascript
// 修改前
const fetchData = async () => {
  const params = {
    startDate: selectedDate.format('YYYY-MM-DD'),
    endDate: selectedDate.format('YYYY-MM-DD')
  };
};

// 修改後
import dayjs from 'dayjs';
import utc from 'dayjs/plugin/utc';
dayjs.extend(utc);

const fetchData = async () => {
  const params = {
    startDate: dayjs(selectedDate).startOf('day').utc().format('YYYY-MM-DD[T]HH:mm:ss[Z]'),
    endDate: dayjs(selectedDate).endOf('day').utc().format('YYYY-MM-DD[T]HH:mm:ss[Z]')
  };
};
```

## 測試結果
1. 檔案上傳：
   - ✅ 成功保存到 FileAttachments 表
   - ✅ 生成永久 URL

2. 檔案預覽：
   - ✅ 圖片可以正常預覽
   - ✅ 支持大圖查看

3. 檔案下載：
   - ✅ 直接下載無需新開分頁
   - ✅ 保持原始檔名

4. 日期篩選：
   - ✅ 可以查詢到當天記錄
   - ✅ 時區處理正確

## 注意事項
1. 確保後端 `uploads/WorkLog/` 目錄具有適當的讀寫權限
2. 檢查 `FileAttachments` 表的備份策略
3. 監控檔案存儲空間使用情況

## 後續建議
1. 考慮添加檔案大小限制
2. 實現檔案批量下載功能
3. 添加檔案預覽支持更多格式（如 PDF）
4. 優化大檔案上傳的進度顯示
