# 九張數據卡片功能開發說明文件

## 📋 文件資訊
- **建立日期**: 2025-09-19
- **功能範圍**: 績效儀表板數據卡片系統
- **開發者**: AI Assistant
- **檔案位置**: `src/components/PerformanceDashboard.js`

## 🎯 功能概述

本系統實現了完整的員工績效評估儀表板，包含九張數據卡片的數據呈現、詳細資訊模態框、以及三個主要檢視頁面的數據串接與功能優化。

## 📊 九張數據卡片架構

### 1. 數據卡片配置 (metrics 陣列)

```javascript
const metrics = [
  {
    id: "workCompletion",        // 工作完成量
    id: "quality",               // 產品質量  
    id: "workHours",             // 工作時間
    id: "attendance",            // 差勤紀錄
    id: "machineStatus",         // 機台運行狀態
    id: "maintenance",           // 機台維護紀錄
    id: "targetAchievement",     // 目標達成率
    id: "kpi",                   // 關鍵績效指標
    id: "efficiency"             // 效率指標
];
```

### 2. 數據卡片核心屬性

每張數據卡片包含以下核心屬性：

```javascript
{
  id: "唯一識別碼",
  title: "顯示標題",
  value: (data) => 數值計算函數,
  unit: "單位",
  description: (data) => 描述函數,
  icon: React圖標組件,
  color: "顏色類別",
  target: 目標百分比,
  weight: 權重,
  scoreCalculation: (data) => 特殊評分計算 // 可選
}
```

## 🔧 特殊數據處理邏輯

### 1. 出勤紀錄 (attendance)
- **顯示格式**: 天數格式 (`17/22天`)
- **評分邏輯**: 使用百分比數值 (`77.3%`)
- **數據來源**: `workLogAPI.getEmployeeAttendance()`

```javascript
value: (data) => {
  if (data.attendanceDetails) {
    return `${data.attendanceDetails.filledDays}/${data.attendanceDetails.workDays}`;
  }
  return 'N/A';
}
```

### 2. 機台維護紀錄 (maintenance)
- **顯示格式**: 次數格式 (`0次`)
- **評分邏輯**: 反向計算 (次數越少分數越高)
- **計算公式**: `100 - (維護次數 / 最大維護次數) × 100`

```javascript
scoreCalculation: (data) => {
  const maintenanceCount = data?.maintenance_Count || 0;
  const maxMaintenanceCount = 10;
  return Math.max(0, 100 - (maintenanceCount / maxMaintenanceCount) * 100);
}
```

### 3. 工作時間 (workHours)
- **顯示格式**: 小時數 (`1小時`)
- **評分邏輯**: 轉換為效率百分比
- **計算公式**: `(實際工時 / 標準工時176) × 100`

### 4. 機台運行狀態 (machineStatus)
- **顯示格式**: 小時數 (`1318.83小時`)
- **評分邏輯**: 轉換為運行效率百分比
- **計算公式**: `(運行時數 / 標準運行時數720) × 100`

### 5. 效率指標 (efficiency)
- **顯示格式**: 百分比 (最高100%)
- **限制邏輯**: `Math.min(100, percentage)`
- **計算公式**: `(實際效率 / 標準效率1000) × 100`

## 🎨 詳細資訊模態框設計

### 1. 模態框結構
```
┌─ 標題區域 (指標名稱 + 關閉按鈕)
├─ 得分計算表整合說明
├─ 詳細評分依據
├─ 績效洞察分析
│  ├─ 趨勢軌跡 (6個月歷史數據)
│  └─ 關鍵指標 (當前表現、最佳記錄、平均水準、穩定指數)
├─ 系統預測 (下月預期)
└─ 智能建議
```

### 2. 趨勢軌跡計算
- **數據來源**: `getRecentMonthsData()` 函數
- **時間範圍**: 最近6個月
- **數據處理**: 支援月度/年度統計切換

### 3. 關鍵指標統計
```javascript
// 統計計算邏輯
const stats = {
  current: 當前表現值,
  best: Math.max(...values),
  average: values.reduce((a, b) => a + b, 0) / values.length,
  stability: 穩定指數計算
};
```

## 📈 三個主要檢視頁面

### 1. 績效儀表板 (dashboard)
- **功能**: 九張數據卡片展示
- **互動**: 點擊卡片開啟詳細資訊模態框
- **數據**: 即時績效數據展示

### 2. 詳細數據 (details)
- **功能**: 表格形式展示所有指標
- **欄位**: 評估項目、數值、目標、狀態
- **特色**: 統一的評分邏輯和狀態判斷

### 3. 改進建議 (recommendations)
- **功能**: 針對每個指標提供專業建議
- **邏輯**: 基於評分等級提供差異化建議
- **內容**: 九個指標各自的專業改進建議

## 🎯 目標值設定

根據業務需求，目標值分配如下：

- **90%目標**: 工作完成量、產品質量
- **85%目標**: 工作時間、差勤紀錄、機台維護紀錄、關鍵績效指標
- **80%目標**: 機台運行狀態、目標達成率、效率指標

## 🔄 數據串接流程

### 1. API數據獲取
```javascript
// 主要API端點
const REPORT_API = {
  BASE_URL: "http://localhost:5000/api",
  ENDPOINTS: {
    kpiOverviewYear: "/Report/GetKPIOverviewYear",
    kpiOverviewMonth: "/Report/GetKPIOverviewMonth"
  }
};
```

### 2. 數據處理流程
```
API回應 → 數據驗證 → 格式轉換 → 狀態更新 → UI渲染
```

### 3. 出勤率特殊處理
```javascript
// 出勤率API調用
const attendanceData = await workLogAPI.getEmployeeAttendance(
  employeeId, 
  targetYear, 
  targetMonth
);
```

## 🎨 UI/UX 優化

### 1. Loading狀態管理
- **防閃爍**: 使用Loading覆蓋層而非清空數據
- **防抖機制**: 100ms延遲避免快速切換
- **狀態保護**: 防止重複載入

### 2. 視覺效果
- **動畫效果**: `animate-glow` 類別
- **顏色系統**: 九種不同顏色區分指標
- **響應式設計**: 支援不同螢幕尺寸

### 3. 互動體驗
- **模態框**: 點擊卡片開啟詳細資訊
- **等級指南**: 評分等級說明
- **趨勢圖表**: 視覺化歷史數據

## 🔧 核心函數說明

### 1. getValueWithUnit()
```javascript
// 統一的數值格式化函數
const getValueWithUnit = (val, isCurrentValue = false, isPrediction = false)
```
- **功能**: 根據指標類型格式化顯示值
- **參數**: 數值、是否當前值、是否預測值
- **返回**: 格式化後的顯示字符串

### 2. getScoreBreakdown()
```javascript
// 評分計算函數
const getScoreBreakdown = (metric, data)
```
- **功能**: 計算指標的詳細評分
- **返回**: 包含基礎分數、調整項目、最終分數

### 3. calculateStability()
```javascript
// 穩定性指數計算
const calculateStability = (values)
```
- **功能**: 基於數據變異性計算穩定指數
- **算法**: 變異係數反向計算

## 📝 開發注意事項

### 1. 數據一致性
- 確保三個頁面使用相同的評分邏輯
- 維護指標、工作時間、機台運行狀態需要特殊處理
- 出勤率顯示格式與評分邏輯分離

### 2. 效能考量
- 使用防抖機制避免頻繁API調用
- Loading狀態管理防止UI閃爍
- 數據緩存減少重複計算

### 3. 擴展性
- metrics陣列配置化，易於新增指標
- 評分邏輯模組化，支援自定義計算
- UI組件化設計，便於維護

## 🚀 未來優化方向

1. **數據緩存**: 實現本地數據緩存機制
2. **即時更新**: WebSocket即時數據推送
3. **自定義指標**: 支援用戶自定義績效指標
4. **導出功能**: 支援數據導出為Excel/PDF
5. **多語言**: 國際化支援

## 💻 技術實現細節

### 1. 狀態管理
```javascript
// 主要狀態變數
const [employeeData, setEmployeeData] = useState({});
const [isLoading, setIsLoading] = useState(false);
const [selectedEmployee, setSelectedEmployee] = useState('');
const [selectedYear, setSelectedYear] = useState(2025);
const [selectedMonth, setSelectedMonth] = useState(9);
const [viewMode, setViewMode] = useState("monthly");
const [activeTab, setActiveTab] = useState("dashboard");
```

### 2. 數據載入邏輯
```javascript
// 統一數據載入函數
const loadEmployeeData = async (employeeId, targetYear, targetMonth, targetDay, isYearly) => {
  setIsLoading(true);
  try {
    // 並行API調用
    const [yearResponse, monthResponse] = await Promise.all([
      fetch(`${REPORT_API.BASE_URL}${REPORT_API.ENDPOINTS.kpiOverviewYear}`),
      fetch(`${REPORT_API.BASE_URL}${REPORT_API.ENDPOINTS.kpiOverviewMonth}`)
    ]);

    // 數據處理和狀態更新
    // ...
  } finally {
    setIsLoading(false);
  }
};
```

### 3. 評分等級系統
```javascript
// 統一評分等級判斷
const getGradeFromScore = (score) => {
  if (score >= 90) return 'A';
  if (score >= 80) return 'B';
  if (score >= 70) return 'C';
  if (score >= 60) return 'D';
  return 'F';
};

// 狀態顏色映射
const getStatusColor = (score) => {
  if (score === 100) return "bg-gradient-to-r from-purple-300 via-purple-100 to-purple-300 text-purple-800";
  if (score >= 90) return "bg-green-100 text-green-800";
  if (score >= 80) return "bg-blue-100 text-blue-800";
  if (score >= 70) return "bg-yellow-100 text-yellow-800";
  if (score >= 60) return "bg-orange-100 text-orange-800";
  return "bg-red-100 text-red-800";
};
```

### 4. 預測算法
```javascript
// 趨勢預測邏輯
const calculatePrediction = (values) => {
  if (values.length < 2) return 'N/A';

  // 線性回歸預測
  const n = values.length;
  const sumX = values.reduce((sum, _, i) => sum + i, 0);
  const sumY = values.reduce((sum, val) => sum + val, 0);
  const sumXY = values.reduce((sum, val, i) => sum + i * val, 0);
  const sumXX = values.reduce((sum, _, i) => sum + i * i, 0);

  const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
  const intercept = (sumY - slope * sumX) / n;

  return slope * n + intercept;
};
```

## 🔍 問題排查指南

### 1. 常見問題
- **數據不顯示**: 檢查API連接和數據格式
- **評分異常**: 確認scoreCalculation函數邏輯
- **UI閃爍**: 檢查Loading狀態管理
- **模態框問題**: 確認事件處理和狀態更新

### 2. 調試技巧
```javascript
// 開啟調試模式
const debugLog = (message, data) => {
  if (process.env.NODE_ENV === 'development') {
    console.log(`[PerformanceDashboard] ${message}`, data);
  }
};
```

### 3. 效能監控
```javascript
// 效能監控
const performanceMonitor = {
  start: performance.now(),
  end() {
    const duration = performance.now() - this.start;
    console.log(`操作耗時: ${duration.toFixed(2)}ms`);
  }
};
```

## 📊 數據流程圖

```
用戶選擇員工/時間
        ↓
   觸發數據載入
        ↓
   並行API調用
        ↓
   數據驗證處理
        ↓
   計算評分指標
        ↓
   更新UI狀態
        ↓
   渲染數據卡片
        ↓
   用戶點擊卡片
        ↓
   開啟詳細模態框
        ↓
   顯示趨勢分析
```

## 🎨 樣式系統

### 1. 顏色配置
```javascript
const colorSystem = {
  workCompletion: "text-blue-500",
  quality: "text-green-500",
  workHours: "text-orange-400",
  attendance: "text-pink-400",
  machineStatus: "text-cyan-400",
  maintenance: "text-purple-400",
  targetAchievement: "text-red-400",
  kpi: "text-yellow-400",
  efficiency: "text-lime-400"
};
```

### 2. 動畫效果
```css
/* 發光動畫 */
.animate-glow {
  animation: glow 2s ease-in-out infinite alternate;
}

@keyframes glow {
  from { text-shadow: 0 0 5px currentColor; }
  to { text-shadow: 0 0 20px currentColor; }
}
```

## 📞 技術支援

### 開發資源
- **主要組件**: `src/components/PerformanceDashboard.js`
- **API工具**: `src/utils/workLogAPI.js`
- **樣式配置**: Tailwind CSS類別
- **圖表庫**: Recharts
- **圖標庫**: Lucide React

### 相關文件
- **API文檔**: 後端API接口說明
- **設計規範**: UI/UX設計指南
- **測試案例**: 功能測試腳本
- **部署指南**: 生產環境部署說明

### 聯絡資訊
- **開發團隊**: AI Assistant
- **技術支援**: 參考代碼註釋和控制台日誌
- **問題回報**: GitHub Issues或開發文檔
