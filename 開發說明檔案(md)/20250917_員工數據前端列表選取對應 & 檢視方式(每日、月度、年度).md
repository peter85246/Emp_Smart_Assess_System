# 員工數據前端列表選取對應 & 檢視方式(每日、月度、年度) 功能說明文檔

## 功能概述

本次更新主要針對前端的員工績效儀表板（PerformanceDashboard）進行了重要優化，實現了三種不同的數據檢視方式：
1. 每日統計
2. 月度統計
3. 年度統計

## 最新更新內容（2025/09/17）

### 1. 數據預設值處理機制

```javascript
const currentEmployeeData = employeeData || {
  completion_Rate: 0,
  yield_Percent: 0,
  total_Hours: 0,
  machine_Run_Hours: 0,
  maintenance_Count: 0,
  otd_Rate: 0,
  kpi_Percent: 0,
  units_Per_Hour: 0,
  attendance: 0
};
```

#### 設計原理
- 確保在無數據時提供預設值
- 防止 UI 顯示 undefined 或 null
- 統一數據格式

### 2. 加載狀態管理

```javascript
const LoadingOverlay = () => (
  <div className="absolute inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div className="text-center bg-slate-800 p-6 rounded-lg shadow-xl">
      <div className="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mb-4 mx-auto"></div>
      <p className="text-slate-300">載入中...</p>
    </div>
  </div>
);

// 使用方式
{isLoading && <LoadingOverlay />}
```

#### 設計原理
- 半透明遮罩避免用戶操作
- 動畫效果提供視覺反饋
- 模糊背景增強視覺層次

### 3. 錯誤處理機制

```javascript
try {
  const response = await fetch(`${REPORT_API.BASE_URL}/AREditior/GetAvailableYears`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    }
  });

  if (!response.ok) throw new Error('獲取年份列表失敗');
  
  // ... 數據處理邏輯 ...
  
} catch (error) {
  console.error('獲取年份列表失敗:', error);
  // 使用預設值
  const currentYear = new Date().getFullYear();
  setAvailableYears([currentYear]);
  setSelectedYear(currentYear);
}
```

#### 設計原理
- 完整的錯誤捕獲
- 預設值回退機制
- 詳細的錯誤日誌

### 4. 日期處理優化

```javascript
const dailyData = employeeMonthData.find(item => {
  const itemDate = new Date(item.work_Day);
  const targetDateObj = new Date(targetDate);
  
  const match = itemDate.getFullYear() === targetDateObj.getFullYear() &&
               itemDate.getMonth() === targetDateObj.getMonth() &&
               itemDate.getDate() === targetDateObj.getDate();
  
  return match;
});
```

#### 設計原理
- 精確的日期比對
- 避免時區問題
- 分開比對年月日

### 5. 數據狀態提示

```javascript
{selectedEmployee && !isLoading && (
  <div className={`mb-6 ${hasData ? 'bg-blue-500/10' : 'bg-yellow-500/10'} rounded-lg p-4`}>
    <div className="flex items-center gap-2">
      <Info className="w-5 h-5" />
      <span className="font-medium">
        {hasData ? '數據載入成功' : '無可用數據'}
      </span>
    </div>
    <p className="mt-1 text-sm opacity-80">
      {hasData ? (
        `已成功載入 ${selectedEmployee} 在 ${selectedYear}年${viewMode !== "yearly" ? `${selectedMonth}月` : ""}${viewMode === "daily" ? `${selectedDay}日` : ""} 的績效數據。`
      ) : (
        `目前所選的${viewMode === "yearly" ? "年度" : viewMode === "monthly" ? "月份" : "日期"}尚無績效數據，系統將顯示預設值。`
      )}
    </p>
  </div>
)}
```

#### 設計原理
- 清晰的視覺提示
- 動態的提示訊息
- 友好的使用者體驗

## 核心功能設計

### 績效趨勢分析功能
績效趨勢分析區塊提供了直觀的數據視覺化展示：

1. 檢視模式切換
   - 年度檢視：顯示12個月的趨勢變化
   - 月度檢視：顯示當月每日的詳細數據

2. 數據指標展示
   - 工作完成量：以百分比顯示完成率趨勢
   - 產品質量：展示良率變化情況
   - 效率指標：顯示效率表現數據

3. 圖表互動特性
   - 動態切換年度/月度視圖
   - 月度視圖下可選擇具體月份
   - 數據點懸停顯示詳細資訊
   - 自動處理空值和異常數據

4. 數據更新機制
   - 選擇員工時自動更新圖表數據
   - 切換檢視模式時重新計算數據
   - 選擇不同月份時即時更新顯示

5. 代碼架構與修改說明
```javascript
// 趨勢圖表數據處理函數
const processChartData = (data, viewMode, year, month, day = 1) => {
  // 數據有效性檢查
  if (!data) return [];

  try {
    let chartData = [];
    
    switch(viewMode) {
      case 'yearly': {
        // 年度視圖：處理12個月的數據
        chartData = Array.from({ length: 12 }, (_, i) => {
          const monthStr = `${year}-${String(i + 1).padStart(2, '0')}-01`;
          // 找出當月的數據並格式化
          const monthData = yearData.find(d => {
            const date = new Date(d.work_Month);
            return date.getMonth() === i && d.user_Name === selectedEmployee;
          });
          return {
            date: monthStr,
            工作完成量: monthData?.completion_Rate ? Math.min(100, Number((monthData.completion_Rate * 100).toFixed(2))) : 0,
            產品質量: monthData?.yield_Percent ? Math.min(100, Number(monthData.yield_Percent.toFixed(2))) : 0,
            效率指標: monthData?.kpi_Percent ? Math.min(100, Number(monthData.kpi_Percent.toFixed(2))) : 0
          };
        });
        break;
      }
      
      case 'monthly': {
        // 月度視圖：處理每日數據
        const daysInMonth = new Date(year, month, 0).getDate();
        chartData = Array.from({ length: daysInMonth }, (_, i) => {
          const dayStr = `${year}-${String(month).padStart(2, '0')}-${String(i + 1).padStart(2, '0')}`;
          // 找出當天的數據並格式化
          const dayData = monthData.find(d => {
            const date = new Date(d.work_Day);
            return date.getDate() === (i + 1) && d.user_Name === selectedEmployee;
          });
          return {
            date: dayStr,
            工作完成量: dayData?.completion_Rate ? Math.min(100, Number((dayData.completion_Rate * 100).toFixed(2))) : 0,
            產品質量: dayData?.yield_Percent ? Math.min(100, Number(dayData.yield_Percent.toFixed(2))) : 0,
            效率指標: dayData?.kpi_Percent ? Math.min(100, Number(dayData.kpi_Percent.toFixed(2))) : 0
          };
        });
        break;
      }
    }
    
    return chartData;
  } catch (error) {
    console.error('處理圖表數據時出錯:', error);
    return [];
  }
};

// 趨勢圖表組件
const PerformanceTrendChart = ({ data, viewMode }) => {
  return (
    <div className="w-full bg-slate-800 rounded-lg p-4 mt-6">
      <ResponsiveContainer width="100%" height={400}>
        <LineChart data={data}>
          <CartesianGrid strokeDasharray="3 3" stroke="#444" />
          <XAxis 
            dataKey="date" 
            stroke="#888"
            interval={0}
            minTickGap={10}
            tickFormatter={(date) => {
              const d = new Date(date);
              return viewMode === 'yearly' ? `${d.getMonth() + 1}月` : `${d.getDate()}日`;
            }}
          />
          <YAxis 
            stroke="#888"
            domain={[0, 100]}
            ticks={[0, 20, 40, 60, 80, 100]}
            tickFormatter={(value) => `${value}%`}
          />
          <Tooltip />
          <Legend />
          <Line type="monotone" dataKey="工作完成量" stroke="#3B82F6" />
          <Line type="monotone" dataKey="產品質量" stroke="#10B981" />
          <Line type="monotone" dataKey="效率指標" stroke="#F59E0B" />
        </LineChart>
      </ResponsiveContainer>
    </div>
  );
};
```

### 主要修改說明
1. 數據處理函數 (processChartData)
   - 根據檢視模式處理不同時間維度的數據
   - 處理空值和異常數據
   - 格式化數據以符合圖表需求
   - 確保數值在合理範圍內（0-100%）

2. 圖表組件 (PerformanceTrendChart)
   - 使用 Recharts 庫實現趨勢圖
   - 自適應容器大小
   - 根據檢視模式動態格式化時間軸
   - 統一的顏色和樣式設計

3. 數據更新觸發點
   - 員工選擇變更時
   - 檢視模式切換時
   - 月份選擇變更時

4. 錯誤處理機制
   - 數據有效性檢查
   - 異常捕獲和日誌記錄
   - 預設值處理

## 數據處理邏輯

### 1. 年度統計
- 累計性指標（如工作時數、維護次數）：計算年度總和
- 比率類指標（如完成率、良率）：計算年度平均值
- 使用 `isYearlyView` 標記來區分年度視圖
- 自動處理 null 值和異常數據

### 2. 月度統計
- 使用 `work_Month` 精確匹配月份數據
- 處理可能的空值情況，確保UI顯示的穩定性
- 提供清晰的數據狀態提示

### 3. 每日統計
- 使用 `work_Day` 精確匹配日期數據
- 格式化日期字符串確保匹配準確性
- 完整的數據有效性檢查
- 智能預設值處理

## 錯誤處理機制

1. API 錯誤處理
   - 網路請求錯誤
   - 回應格式錯誤
   - 數據驗證錯誤

2. 數據預設值
   - null 值處理
   - undefined 處理
   - 異常數據處理

3. 使用者提示
   - 錯誤提示
   - 載入提示
   - 無數據提示

## 使用者體驗優化

1. 視圖切換時自動清空舊數據（`setEmployeeData(null)`）
2. 年度統計模式下隱藏月份選擇器，避免混淆
3. 切換檢視方式時自動調整相關參數
4. 數據加載過程中顯示半透明加載遮罩
5. 清晰的數據狀態提示
6. 動態年份選擇
7. 智能預設值處理

## 注意事項

1. 年度統計模式下：
   - 月份選擇器會被隱藏
   - 所有數據會被重新計算為年度匯總值
   - 部分指標顯示總和，部分顯示平均值
   - 自動處理無效數據

2. 月度統計模式下：
   - 可自由選擇月份
   - 顯示該月份的匯總數據
   - 提供數據有效性提示

3. 每日統計模式下：
   - 可選擇具體日期
   - 顯示單日的詳細數據
   - 智能處理無數據情況
   - 提供清晰的狀態提示

## 後續優化建議

1. 可考慮添加數據導出功能
2. 增加數據對比功能（如不同時期的數據對比）
3. 優化數據加載效能
4. 添加更多的數據視覺化圖表
5. 實現數據快取機制
6. 添加數據趨勢分析
7. 優化移動端體驗

## 技術堆疊

- React Hooks (`useState`, `useEffect`, `useRef`)
- Async/Await 異步處理
- 條件渲染
- 數據聚合計算
- API 整合
- Tailwind CSS 樣式
- 動態組件渲染

## 維護建議

1. 定期檢查 API 回傳的數據格式是否符合預期
2. 監控數據計算邏輯的準確性
3. 注意效能優化，特別是在處理大量數據時
4. 保持代碼的可讀性和可維護性
5. 定期更新依賴套件
6. 持續監控使用者反饋
7. 定期檢查錯誤日誌
8. 監控數據加載時間
9. 檢查預設值處理機制
10. 驗證日期處理邏輯